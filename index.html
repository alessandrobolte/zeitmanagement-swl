<!doctype html>
<html lang="de">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïí</text></svg>">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zeitmanagement</title>
<style>
  :root{
    --bg:#f3f4f6;
    --panel:#ffffff;
    --text:#0b1220;
    --muted:#425066;
    --accent1:#28a745;
    --accent2:#3b82f6;
    --radius:12px;
    --shadow: 0 8px 24px rgba(15,23,42,0.06);
  }
  :root.dark{
    --bg:#0b0b0c;
    --panel:#0f1112;
    --text:#e8e8e8;
    --muted:#9aa0a6;
    --accent1:#ff4d4f;
    --accent2:#ff902b;
    --shadow: 0 8px 28px rgba(0,0,0,0.6);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  .app{width:100%;max-width:1100px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{margin:0;font-size:1.6rem}
  .top-controls{display:flex;gap:10px;align-items:center}
  button{background:var(--panel);border:1px solid rgba(0,0,0,0.06);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
  .small{padding:6px 10px;font-size:0.9rem}
  .ghost{background:transparent}
  .accent{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:#fff}
  .danger{background:transparent;border:1px solid var(--accent1);color:var(--accent1)}

  .top{display:flex;gap:16px;align-items:flex-start}
  .cats-panel{flex:1;background:var(--panel);padding:16px;border-radius:var(--radius)}
  .timer-panel{width:360px;min-width:260px;background:var(--panel);padding:18px;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;gap:10px}

  .category-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .category-card{padding:10px 12px;border-radius:10px;background:linear-gradient(90deg, rgba(0,0,0,0.02), transparent);display:flex;align-items:center;gap:12px;border:1px solid rgba(0,0,0,0.04)}
  .category-name{font-weight:700}
  .category-meta{font-size:0.85rem;color:var(--muted)}

  .time-big{font-size:2.2rem;font-weight:800}
  .timer-controls{display:flex;gap:8px;margin-top:8px}
  select,input{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
  input[type="number"]{width:80px}

  .actions-row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .centered{display:flex;justify-content:center}

  .stats-panel{background:var(--panel);padding:14px;border-radius:var(--radius);margin-top:14px}
  .stats-header{display:flex;align-items:center;justify-content:space-between}
  .toggle-details{cursor:pointer;color:var(--muted);font-size:0.95rem}
  .charts{display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px}
  canvas{background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);border-radius:10px;padding:8px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px 6px;text-align:left;border-bottom:1px dashed rgba(0,0,0,0.06)}
  .sessions-list{max-height:220px;overflow:auto}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--panel);padding:18px;border-radius:12px;min-width:320px;max-width:720px}
  .form-row{display:flex;gap:8px;margin-bottom:8px}
  label{font-size:0.9rem;color:var(--muted);min-width:120px;display:inline-block}

  @media (max-width:980px){ .charts{grid-template-columns:1fr} .timer-panel{width:100%} .top{flex-direction:column} }

  .tooltip{position:absolute;padding:6px 8px;border-radius:6px;background:var(--panel);border:1px solid rgba(0,0,0,0.06);pointer-events:none;font-size:0.9rem;z-index:10000}
  /* Sanftes Pulsieren w√§hrend des Ladens */
@keyframes pulse {
  0% { opacity: 0.5; }
  50% { opacity: 1; }
  100% { opacity: 0.5; }
}

/* Sanftes Ausblenden */
.fade-out {
  opacity: 0;
  transition: opacity 0.4s ease;
}
#toast.show {
  display: block !important;
  opacity: 1 !important;
}
/* Toast-Styling mit Theme-Anpassung */
#toast {
  z-index: 9999;
  backdrop-filter: blur(6px);
}

:root:not(.dark) #toast {
  background: #0077cc; /* kr√§ftiges Blau im Lightmode */
  color: white;
}

.dark #toast {
  background: #ff6600; /* warmes Orange im Darkmode */
  color: #fff;
}
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
	<!-- Ladeanzeige -->
<div id="loading"
     style="display:none;
            text-align:center;
            font-weight:500;
            margin-top:10px;
            color:var(--accent);
            opacity:0;
            transition:opacity 0.4s ease;">
  ‚è≥ Lade Daten ‚Ä¶
</div>
<!-- Erfolgsmeldung -->
<div id="toast"
     style="display:none;
            position:fixed;
            top:20px;
            right:20px;
            background:var(--accent);
            color:white;
            padding:10px 16px;
            border-radius:8px;
            font-weight:500;
            box-shadow:0 2px 10px rgba(0,0,0,0.2);
            opacity:0;
            transition:opacity 0.4s ease;">
  Daten neu geladen ‚úÖ
</div>
      <h1>Zeitmanagement</h1>
      <div class="top-controls">
        <button id="modeToggle" class="small" title="Toggle Theme">‚òÄÔ∏è</button>
      </div>
    </header>

    <div class="top">
      <section class="cats-panel" aria-labelledby="catsTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="addCategoryBtn" class="accent small" aria-label="Kategorie hinzuf√ºgen">Kategorie hinzuf√ºgen</button>
            <button id="delModeBtn" class="ghost small" aria-pressed="false" title="In den L√∂sch-Modus wechseln">L√∂schen</button>
          </div>
          <div style="text-align:right">
            <div id="catsTitle" style="font-size:0.9rem;color:var(--muted)">Kategorien</div>
          </div>
        </div>

        <div class="category-list" id="categoryList" aria-live="polite" style="margin-top:12px"></div>

        <div class="actions-row" style="margin-top:12px">
          <input type="file" id="importFile" accept=".csv,text/csv" style="display:none" aria-hidden="true" />
          <button id="exportBtn" class="small ghost" title="Export als CSV">Export (CSV)</button>
          <button id="importBtn" class="small ghost" title="Import aus CSV">Import</button>
		  <button id="refreshBtn" class="small ghost" title="Daten neu laden">üîÑ Refresh</button>
          <button id="resetBtn" class="small danger" title="Reset Optionen">Reset</button>
        </div>

        <div class="centered" style="margin-top:10px">
          <button id="forgotBtn" class="accent" style="white-space:nowrap">Zeit stoppen vergessen?</button>
        </div>
      </section>

      <aside class="timer-panel" aria-label="Timer Panel">
        <div style="font-size:0.9rem;color:var(--muted)">Aktueller Timer</div>
        <div class="time-big" id="activeTimerDisplay">--:--:--</div>
        <div style="width:100%;display:flex;gap:8px;align-items:center">
          <label for="activeCategorySelect" style="min-width:110px;color:var(--muted)">Kategorie</label>
          <select id="activeCategorySelect" aria-label="Aktive Kategorie" style="flex:1"></select>
        </div>
        <div class="timer-controls" style="width:100%;justify-content:center">
          <button id="startBtn" class="small">Start</button>
          <button id="stopBtn" class="small">Stop</button>
        </div>
        <div style="font-size:0.9rem;color:var(--muted);text-align:center;margin-top:6px">Timer l√§uft auch nach Reload weiter</div>
      </aside>
    </div>

    <section class="stats-panel" id="statsPanel" aria-labelledby="statsTitle">
      <div class="stats-header">
        <div style="display:flex;gap:10px;align-items:center">
          <div id="statsTitle" style="font-weight:700">Statistiken</div>
          <div id="rangeButtons" style="display:flex;gap:6px">
            <button class="small" data-range="7">Letzte 7 Tage</button>
            <button class="small" data-range="14">Letzte 14 Tage</button>
            <button class="small" data-range="30">30 Tage</button>
            <button class="small" data-range="all">Gesamt</button>
          </div>
        </div>
        <div class="toggle-details" id="toggleStats">Ausklappen ‚ñæ</div>
      </div>

      <div id="statsContent" style="display:none;margin-top:10px">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:320px">
            <table id="statsTable" aria-label="Statistiken Tabelle">
              <thead><tr><th>Kategorie</th><th>Gesamt</th><th>√ò / Tag</th><th>/ Woche</th><th>Sessions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="width:420px">
            <canvas id="barChart" width="420" height="220" role="img" aria-label="Balkendiagramm"></canvas>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:8px">Verlauf</div>
          <canvas id="lineChart" width="980" height="240" style="width:100%" role="img" aria-label="Liniendiagramm"></canvas>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:8px">Sessions (Details)</div>
          <div class="sessions-list"><table id="sessionsTable"><thead>
  <tr>
    <th>Datum</th>
    <th>Kategorie</th>
    <th>Dauer</th>
    <th>Notiz</th>
  </tr>
</thead><tbody></tbody></table></div>
        </div>
      </div>
    </section>

    <div id="modalRoot"></div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ---- Token-Pr√ºfung ----
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html"; // Weiterleitung, falls kein Token vorhanden
    return; // Rest des Scripts nicht ausf√ºhren
  }
  let _zm_user = null;
  try {
    const userData = JSON.parse(atob(token));
    console.log("Eingeloggt als:", userData.username, "Rolle:", userData.role);
    _zm_user = userData; // global verf√ºgbar
    window._zm_user = _zm_user;
  } catch {
    localStorage.removeItem("token");
    window.location.href = "login.html";
    return;
  }
  // -----------------------

  const loadingEl = document.getElementById('loading');

  // Zeigt die Ladeanzeige, sobald die Seite initialisiert wird
  loadingEl.style.display = 'block';
  setTimeout(() => loadingEl.style.opacity = 1, 20);

  // Danach (nach dem Laden der Daten) ausblenden
  async function load() {
    loadingEl.style.opacity = 1;

    try {
      const res = await fetch("/functions/loadData");
      if (res.ok) {
        const remoteData = await res.json();
        if (remoteData && typeof remoteData === "object") {
          state.categories = remoteData.categories || [];
          state.active = remoteData.active || null;
          state.theme = remoteData.theme || "light"; // üü¢ sauber integriert
          console.log("Cloud-Daten geladen ‚úÖ (inkl. Theme)");
        }
      } else {
        console.warn("‚ö†Ô∏è loadData antwortet mit:", res.status);
      }
    } catch (e) {
      console.warn("‚ö†Ô∏è Konnte Cloud-Daten nicht laden:", e);
    }

    // üîπ Lokale Fallback-Daten laden, falls Cloud fehlte
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") state = parsed;
      } catch (e) {
        console.error("‚ö†Ô∏è Lokale Daten fehlerhaft:", e);
        localStorage.removeItem(LS_KEY);
      }
    }

    // üîπ Aktive Session aus localStorage wiederherstellen
    const activeRaw = localStorage.getItem(LS_ACTIVE);
    if (activeRaw) {
      try {
        state.active = JSON.parse(activeRaw);
      } catch {
        state.active = null;
      }
    }

    // üîπ Theme aus localStorage (h√∂chste Priorit√§t)
    const themeRaw = localStorage.getItem(LS_THEME);
    if (themeRaw) {
      state.theme = themeRaw;
    }

    ensure();

    // üîπ Ladeanzeige sanft ausblenden
    setTimeout(() => {
      loadingEl.style.opacity = 0;
      setTimeout(() => (loadingEl.style.display = "none"), 400);
    }, 500);
  }

  const LS_KEY = 'zm:data_v1';
  const LS_ACTIVE = 'zm:active_v1';
  const LS_THEME = 'zm:theme_v1';

  let state = { categories: [], active: null, theme: 'light' };
  
  // üü¢ Theme beim Start sofort anwenden (verhindert Flackern)
  
  const uid = ()=> Math.random().toString(36).slice(2,9);
  const msToHms = ms => {
    if(!isFinite(ms)) return '--:--:--';
    const secs = Math.floor(ms/1000);
    const h = Math.floor(secs/3600), m = Math.floor((secs%3600)/60), s = secs%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  };
  const minutesToHuman = min => { const h = Math.floor(min/60); const m = Math.round(min%60); return `${h}h ${m}m`; };
  const escapeHtml = t => String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const categoryList = document.getElementById('categoryList');
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const delModeBtn = document.getElementById('delModeBtn');
  const activeCategorySelect = document.getElementById('activeCategorySelect');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const activeTimerDisplay = document.getElementById('activeTimerDisplay');
  const forgotBtn = document.getElementById('forgotBtn');
  const modalRoot = document.getElementById('modalRoot');
  const resetBtn = document.getElementById('resetBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const loading = document.getElementById('loading');
  const importFile = document.getElementById('importFile');
  const toggleStats = document.getElementById('toggleStats');
  const statsContent = document.getElementById('statsContent');
  const statsTableBody = document.querySelector('#statsTable tbody');
  const sessionsTableBody = document.querySelector('#sessionsTable tbody');
  const barCanvas = document.getElementById('barChart');
  const lineCanvas = document.getElementById('lineChart');
  const timespanButtons = document.getElementById('rangeButtons');
  const modeToggle = document.getElementById('modeToggle');

  // load/save
  async function load() {
  // üü° Ladeanzeige einblenden
  loading.style.display = "block";

  try {
    const res = await fetch("/functions/loadData");
    if (res.ok) {
      const remoteData = await res.json();
      if (remoteData && remoteData.categories) {
        state = remoteData;
        console.log("Cloud-Daten geladen ‚úÖ");
      }
    }
  } catch (e) {
    console.warn("Konnte Cloud-Daten nicht laden:", e);
  }

  const raw = localStorage.getItem(LS_KEY);
  if (raw) {
    try {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object") state = parsed;
    } catch (e) {
      console.error(e);
      localStorage.removeItem(LS_KEY);
    }
  }

  const activeRaw = localStorage.getItem(LS_ACTIVE);
  if (activeRaw) {
    try {
      state.active = JSON.parse(activeRaw);
    } catch {
      state.active = null;
    }
  }

  const themeRaw = localStorage.getItem(LS_THEME);
  if (themeRaw) state.theme = themeRaw;
  ensure();

  // üü¢ Ladeanzeige sanft ausblenden
  loading.classList.add("fade-out");
  document.documentElement.classList.toggle('dark', state.theme === 'dark');
  setTimeout(() => (loading.style.display = "none"), 400);
}
async function save() {
  try {
    // üîπ Lokale Sicherung (Offline-Fallback)
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    if (state.active) localStorage.setItem(LS_ACTIVE, JSON.stringify(state.active));
    localStorage.setItem(LS_THEME, state.theme || "light");

    // üîπ Cloud-Sync mit Netlify ‚Üí GitHub
    const res = await fetch("/functions/saveData", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        categories: state.categories || [],
        active: state.active || null,
        theme: state.theme || "light"
      })
    });
  } catch (e) {
    console.warn("Cloud-Sync fehlgeschlagen:", e);
  }
}
  function ensure(){ state.categories = state.categories || []; state.active = state.active || null; state.theme = state.theme || 'light'; state.categories.forEach(c=> c.sessions = c.sessions || []); }

  load();
let currentRange = '7';
 let delMode = false;
  applyTheme();
  renderAll();

  function applyTheme(){
    if(state.theme === 'light'){ document.documentElement.classList.remove('dark'); }
    else { document.documentElement.classList.add('dark'); }
    modeToggle.textContent = state.theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    drawBarChart(); drawLineChart();
  }
  modeToggle.addEventListener('click', ()=>{
    state.theme = state.theme === 'light' ? 'dark' : 'light'; applyTheme(); save();
  });

  // categories render
   function renderCategories(){
    categoryList.innerHTML=''; activeCategorySelect.innerHTML='';
    for(const c of state.categories){
      const card = document.createElement('div'); card.className='category-card'; card.dataset.id = c.id;
      const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
      const name = document.createElement('div'); name.className='category-name'; name.textContent = c.name;
      const meta = document.createElement('div'); meta.className='category-meta';
      const totalMin = (c.sessions||[]).reduce((s,x)=> s + (x.durationMin || (x.end? Math.round((x.end-x.start)/60000):0)), 0);
      meta.textContent = `${totalMin} min ‚Ä¢ ${ (c.sessions||[]).length } sessions`;
      left.appendChild(name); left.appendChild(meta);

      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.alignItems='center'; actions.style.gap='8px';

      const startBtnLocal = document.createElement('button'); startBtnLocal.className='small'; startBtnLocal.textContent='Start'; startBtnLocal.title='Timer f√ºr diese Kategorie starten';
      startBtnLocal.onclick = ()=>{ activeCategorySelect.value = c.id; startTimer(); };

      const detailsBtn = document.createElement('button'); detailsBtn.className='small ghost'; detailsBtn.textContent='Details'; detailsBtn.onclick = ()=> showCategoryDetails(c.id);

      actions.appendChild(startBtnLocal); actions.appendChild(detailsBtn);

      if(delMode){
        const del = document.createElement('button'); del.className='small danger'; del.textContent='L√∂schen'; del.onclick = ()=> deleteCategory(c.id);
        actions.appendChild(del);
      }

      card.appendChild(left); card.appendChild(actions);
      categoryList.appendChild(card);

      const option = document.createElement('option'); option.value=c.id; option.textContent=c.name; activeCategorySelect.appendChild(option);
    }
    if(state.categories.length === 0){
      const info = document.createElement('div'); info.style.color='var(--muted)'; info.style.marginTop='8px'; info.textContent='Noch keine Kategorien. Lege eine an.'; categoryList.appendChild(info);
    }
  }

addCategoryBtn.addEventListener('click', () => {
  const name = prompt('Name der Kategorie (z.B. Arbeit, Lernen):');
  if (!name) return;

  // üîç pr√ºfen, ob Kategorie schon existiert (Gro√ü-/Kleinschreibung ignorieren)
  const exists = state.categories.some(c => c.name.toLowerCase() === name.toLowerCase());
  if (exists) {
    alert('Diese Kategorie existiert bereits.');
    return;
  }

  const id = uid();
  state.categories.push({ id, name, sessions: [] });
  save();
  renderAll();
});

  delModeBtn.addEventListener('click', ()=>{
    delMode = !delMode; delModeBtn.textContent = delMode ? 'Fertig' : 'L√∂schen'; delModeBtn.setAttribute('aria-pressed', String(delMode)); renderCategories();
  });

  function deleteCategory(id){
    if(!confirm('Kategorie und alle zugeh√∂rigen Sessions wirklich l√∂schen?')) return;
    state.categories = state.categories.filter(c=>c.id!==id);
    if(state.active && state.active.categoryId===id) state.active=null;
    save(); renderAll();
  }

  // timer
  startBtn.addEventListener('click', startTimer);
  stopBtn.addEventListener('click', stopTimer);

  function startTimer(){
    const catId = activeCategorySelect.value || (state.categories[0] && state.categories[0].id);
    if(!catId){ alert('Bitte zuerst eine Kategorie anlegen und ausw√§hlen.'); return; }
    if(state.active){ alert('Es l√§uft bereits ein Timer. Stoppe ihn zuerst.'); return; }
    const start = Date.now(); state.active = {categoryId:catId, start};
    const cat = state.categories.find(c=>c.id===catId); cat.sessions = cat.sessions || []; cat.sessions.push({id: uid(), start, end: null, durationMin: null});
    save(); renderAll();
  }

function stopTimer() {
  if (!state.active) {
    alert('Kein laufender Timer.');
    return;
  }

  const a = state.active;
  const end = Date.now();
  const cat = state.categories.find(c => c.id === a.categoryId);
  if (!cat) return;

  const session = cat.sessions && cat.sessions.slice().reverse().find(s => !s.end && (s.start === a.start || s.start <= a.start));
  if (session) {
    session.end = end;
    session.durationMin = Math.max(1, Math.round((session.end - session.start) / 60000));

    // üü¢ Nach Ende direkt Notiz abfragen
    const modal = openModal(`
      <h3>Session-Notiz hinzuf√ºgen</h3>
      <div style="margin-top:8px">
        <textarea id="noteText" rows="3" style="width:100%;border-radius:8px;padding:6px;border:1px solid var(--muted);" placeholder="Kurze Beschreibung dieser Session..."></textarea>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="saveNote" class="accent small">Speichern</button>
        <button id="skipNote" class="small">√úberspringen</button>
      </div>
    `);

    // üß† Fokus direkt auf das Textfeld setzen
    const textArea = modal.querySelector('#noteText');
    setTimeout(() => textArea.focus(), 50);

    modal.querySelector('#saveNote').onclick = () => {
      const text = textArea.value.trim();
      session.note = text;
      closeModal();
      finishStop();
    };

    modal.querySelector('#skipNote').onclick = () => {
      closeModal();
      finishStop();
    };
  } else {
    finishStop();
  }

  function finishStop() {
    state.active = null;
    localStorage.removeItem(LS_ACTIVE);
    save();
    renderAll();
  }
}

  // active timer display
  setInterval(()=>{
    if(state.active){
      const secs = Math.floor((Date.now() - state.active.start)/1000);
      activeTimerDisplay.textContent = msToHms(secs*1000);
    } else activeTimerDisplay.textContent = '--:--:--';
  },500);

  // manual entry
  forgotBtn.addEventListener('click', openManualModal);

  function openManualModal(){
    const modal = openModal(`<h3>Manuelles Nachtragen</h3>
      <div class="form-row"><label for="mcat">Kategorie</label><select id="mcat" aria-label="Kategorie w√§hlen">${state.categories.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}</select></div>
      <div class="form-row"><label for="mdate">Datum</label><input id="mdate" type="date" /></div>
      <div class="form-row"><label for="mhours">Dauer</label><input id="mhours" type="number" min="0" placeholder="Stunden" /> <input id="mmins" type="number" min="0" max="59" placeholder="Minuten" /></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="madd" class="accent">Hinzuf√ºgen</button><button id="mclose" class="small">Abbrechen</button></div>
    `);
    modal.querySelector('#mclose').onclick = ()=> closeModal();
    modal.querySelector('#madd').onclick = ()=>{
      const catId = modal.querySelector('#mcat').value; const date = modal.querySelector('#mdate').value;
      const hours = parseInt(modal.querySelector('#mhours').value||'0',10); const mins = parseInt(modal.querySelector('#mmins').value||'0',10);
      if(!catId || !date || (hours===0 && mins===0)){ alert('Bitte Kategorie, Datum und Dauer angeben.'); return; }
      const start = new Date(date+'T00:00:00').getTime(); const durationMin = hours*60 + mins; const end = start + durationMin*60000;
      const cat = state.categories.find(c=>c.id===catId); cat.sessions = cat.sessions || []; cat.sessions.push({id:uid(), start, end, durationMin});
      save(); closeModal(); renderAll();
    };
  }

  // reset
  resetBtn.addEventListener('click', ()=>{
    const modal = openModal(`<h3>Reset</h3>
      <div style="margin-top:8px">W√§hle aus was gel√∂scht werden soll:</div>
      <div style="margin-top:8px"><label><input type="checkbox" id="rCats" checked /> Kategorien l√∂schen</label></div>
      <div style="margin-top:6px"><label><input type="checkbox" id="rTimes" checked /> Zeiten l√∂schen</label></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button id="rdo" class="danger">L√∂schen</button><button id="rc" class="small">Abbrechen</button></div>
    `);
    modal.querySelector('#rc').onclick = ()=> closeModal();
    modal.querySelector('#rdo').onclick = ()=>{
      const delCats = modal.querySelector('#rCats').checked; const delTimes = modal.querySelector('#rTimes').checked;
      if(!confirm('Bist du sicher? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) return;
      if(delCats){ state.categories = []; state.active=null; localStorage.removeItem(LS_ACTIVE); }
      else if(delTimes){ state.categories.forEach(c=> c.sessions = []); state.active=null; localStorage.removeItem(LS_ACTIVE); }
      save(); closeModal(); renderAll();
    };
  });

  // export/import
  exportBtn.addEventListener('click', ()=>{
  const rows = ['category,categoryId,startISO,endISO,durationMin,note'];
  state.categories.forEach(c=>{
    (c.sessions||[]).forEach(s=>{
      rows.push(`${escapeCsv(c.name)},${c.id},${new Date(s.start).toISOString()},${s.end?new Date(s.end).toISOString():''},${s.durationMin||''},${escapeCsv(s.note || '')}`);
    });
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='zeitmanagement_export.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const txt = await f.text(); parseImportCSV(txt); importFile.value=''; });

  function parseImportCSV(txt){
    const lines = txt.split(/\r?\n/).filter(Boolean);
    if(lines.length<=1){ alert('Keine Daten in CSV gefunden'); return; }
    lines.shift();
    for(const line of lines){
      const parts = csvSplit(line);
      if(parts.length<5) continue;
      const catName = parts[0]; const catId = parts[1] || uid(); const startISO = parts[2];
const endISO = parts[3];
const dur = parts[4] ? parseInt(parts[4],10) : null;
const note = parts[5] ? parts[5] : '';
let cat = state.categories.find(c=>c.id===catId) || state.categories.find(c=>c.name===catName);
if(!cat){ cat = {id:catId,name:catName,sessions:[]}; state.categories.push(cat); }
const start = startISO ? new Date(startISO).getTime() : null;
const end = endISO ? new Date(endISO).getTime() : (start && dur ? start + dur*60000 : null);
if(start) cat.sessions.push({id:uid(), start, end, durationMin: dur, note});
    }
    save(); renderAll();
  }

  function escapeCsv(t){ if(t==null) return ''; const s=String(t); if(s.includes(',')||s.includes('"')||s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"'; return s; }
  function csvSplit(line){ const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(inQ){ if(ch==='\"' && line[i+1]==='\"'){ cur+='"'; i++; } else if(ch==='\"'){ inQ=false; } else cur+=ch; } else { if(ch===','){ out.push(cur); cur=''; } else if(ch==='\"'){ inQ=true; } else cur+=ch; } } out.push(cur); return out; }

  // stats & charts
  
  timespanButtons.addEventListener('click',(e)=>{ const b = e.target.closest('button'); if(!b) return; currentRange = b.dataset.range; renderStats(); });
  toggleStats.addEventListener('click', ()=>{
    const open = statsContent.style.display === 'block'; statsContent.style.display = open ? 'none' : 'block'; toggleStats.textContent = open? 'Ausklappen ‚ñæ' : 'Einklappen ‚ñ¥';
    if(!open){ drawBarChart(); drawLineChart(); }
  });

  function renderStats(){
    const now = Date.now(); let from = 0;
    if(currentRange==='7') from = now - 7*24*3600*1000;
    else if(currentRange==='14') from = now - 14*24*3600*1000;
    else if(currentRange==='30') from = now - 30*24*3600*1000;
    else from = 0;

    const agg = state.categories.map(c=>{
      let totalMin = 0; let sessions=0; const daysSet=new Set();
      (c.sessions||[]).forEach(s=>{
        if(!s.start) return;
        if(from && s.end && s.end < from) return;
        const dur = s.durationMin || (s.end? Math.round((s.end - s.start)/60000):0);
        totalMin += dur; if(dur>0) sessions++;
        const dateKey = new Date(s.start).toISOString().slice(0,10); daysSet.add(dateKey);
      });
      const days = from ? Math.max(1, Math.ceil((Date.now()-from)/(24*3600*1000))) : Math.max(1, daysSet.size);
      const perDay = totalMin/days; const perWeek = totalMin/7;
      return {id:c.id,name:c.name,totalMin,perDay,perWeek,sessions};
    });

    statsTableBody.innerHTML = '';
    agg.forEach(a=>{
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(a.name)}</td><td>${minutesToHuman(Math.round(a.totalMin))}</td><td>${Math.round(a.perDay)} min</td><td>${Math.round(a.perWeek)} min</td><td>${a.sessions}</td>`; statsTableBody.appendChild(tr);
    });

    const allSessions = [];
    state.categories.forEach(c=>{ (c.sessions||[]).forEach(s=>{ if(!s.start) return; if(from && s.end && s.end < from) return; const dur = s.durationMin || (s.end? Math.round((s.end-s.start)/60000):0); allSessions.push({date:new Date(s.start), cat:c.name, dur, note: s.note || ''});
 }); });
    allSessions.sort((a,b)=>b.date - a.date);
    sessionsTableBody.innerHTML = allSessions.map(s=>{
  const noteText = escapeHtml(s.note || '');
  return `<tr>
    <td>${s.date.toLocaleString()}</td>
    <td>${escapeHtml(s.cat)}</td>
    <td>${minutesToHuman(s.dur)}</td>
    <td>${noteText}</td>
  </tr>`;
}).join('');

    drawBarChart(); drawLineChart();
  }

  function drawBarChart(){
    const ctx = barCanvas.getContext('2d'); const w = barCanvas.width; const h = barCanvas.height; ctx.clearRect(0,0,w,h);
    const totals = state.categories.map(c=> (c.sessions||[]).reduce((a,s)=> a + (s.durationMin || (s.end?Math.round((s.end-s.start)/60000):0)), 0));
    const max = Math.max(1, ...totals);
    const padding = 30; const count = Math.max(1,state.categories.length); const barW = Math.max(20, (w - padding*2)/count - 8);
    state.categories.forEach((c,i)=>{
      const val = totals[i]; const x = padding + i*(barW+8);
      const hBar = (val/max) * (h - 60);
      const y = h - 30 - hBar;
      const grad = ctx.createLinearGradient(x,y,x,y+hBar);
      grad.addColorStop(0, getCssVar('--accent1')); grad.addColorStop(1, getCssVar('--accent2'));
      ctx.fillStyle = grad; roundRect(ctx,x,y,barW,hBar,8); ctx.fill();
      ctx.fillStyle = getCssVar('--muted'); ctx.font='12px sans-serif'; ctx.fillText(c.name || '‚Äî', x, h-10);
      ctx.fillStyle = getCssVar('--text'); ctx.font='11px sans-serif'; ctx.fillText(minutesToHuman(Math.round(val)), x, y-6);
    });
  }

  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  function getCssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#fff'; }

  function drawLineChart(){
    const ctx = lineCanvas.getContext('2d'); const rect = lineCanvas.getBoundingClientRect(); const DPR = window.devicePixelRatio || 1;
    lineCanvas.width = Math.floor(rect.width * DPR); lineCanvas.height = Math.floor(240 * DPR); ctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.clearRect(0,0,rect.width,240);

    let days = 7; if(currentRange==='14') days=14; else if(currentRange==='30') days=30; else if(currentRange==='all') days = 30;
    const now = new Date(); const labels = []; const dayMs = 24*3600*1000;
    for(let i=days-1;i>=0;i--){ const d = new Date(now.getTime() - i*dayMs); labels.push(d.toISOString().slice(0,10)); }

    const padding = {l:40,r:20,t:20,b:40}; const W = rect.width - padding.l - padding.r; const H = 240 - padding.t - padding.b;

    const series = state.categories.map(c=>{
      const arr = labels.map(()=>0);
      (c.sessions||[]).forEach(s=>{
        if(!s.start) return; const d = new Date(s.start).toISOString().slice(0,10); const idx = labels.indexOf(d);
        if(idx>=0){ const dur = s.durationMin || (s.end? Math.round((s.end-s.start)/60000):0); arr[idx]+=dur; }
      });
      return {name:c.name, arr};
    });

    let max = 1; series.forEach(s=> s.arr.forEach(v=> max = Math.max(max, v)));

    ctx.strokeStyle = getCssVar('--muted'); ctx.fillStyle = getCssVar('--muted'); ctx.font='12px sans-serif';
    for(let i=0;i<=4;i++){ const y = padding.t + (H*(i/4)); ctx.beginPath(); ctx.moveTo(padding.l,y); ctx.lineTo(padding.l+W,y); ctx.stroke(); const val = Math.round(max*(1 - i/4)); ctx.fillText(minutesToHuman(val), 6, y+4); }

    labels.forEach((lab,i)=>{ if(i%Math.ceil(labels.length/7) !== 0) return; const x = padding.l + (W*(i/(labels.length-1||1))); ctx.fillText(lab.slice(5), x-12, padding.t+H+16); });

    series.forEach((s,si)=>{
      const color1 = state.theme==='light' ? getCssVar('--accent2') : getCssVar('--accent1');
      ctx.beginPath(); s.arr.forEach((v,i)=>{ const x = padding.l + (W*(i/(labels.length-1||1))); const y = padding.t + H*(1 - (v/max)); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.lineWidth = 2; ctx.strokeStyle = color1; ctx.stroke();
      ctx.lineTo(padding.l+W, padding.t+H); ctx.lineTo(padding.l, padding.t+H); ctx.closePath(); ctx.globalAlpha=0.06; ctx.fillStyle=color1; ctx.fill(); ctx.globalAlpha=1;
    });

    lineCanvas.onmousemove = function(e){
      const rect = lineCanvas.getBoundingClientRect(); const x = e.clientX - rect.left; const relX = x - padding.l; if(relX<0 || relX>W) return;
      const idx = Math.round((relX / W) * (labels.length-1)); showLineTooltip(e.clientX, e.clientY, labels[idx], series.map(s=>({name:s.name, val:s.arr[idx]}))); };
    lineCanvas.onmouseleave = ()=> hideTooltip();
  }

  let tooltipEl = null;
  function showLineTooltip(pageX,pageY,date,vals){
    hideTooltip();
    tooltipEl = document.createElement('div'); tooltipEl.className='tooltip'; tooltipEl.style.left=(pageX+12)+'px'; tooltipEl.style.top=(pageY+8)+'px';
    const inner = `<strong>${date}</strong><br/>` + (vals.filter(v=>v.val>0).map(v=>`${escapeHtml(v.name)}: ${minutesToHuman(v.val)}`).join('<br/>') || 'Keine Daten');
    tooltipEl.innerHTML = inner; document.body.appendChild(tooltipEl);
  }
  function hideTooltip(){ if(tooltipEl){ tooltipEl.remove(); tooltipEl=null; } }

  // stats render and helpers defined above
  function renderAll(){ renderCategories(); renderStats(); }

  function showCategoryDetails(id){
  const c = state.categories.find(x=>x.id===id);
  if(!c) return;

  const content = `
    <h3>Details ‚Äî ${escapeHtml(c.name)}</h3>
    <div style="max-height:320px;overflow:auto;margin-top:8px">
      <table style='width:100%'>
        <thead>
          <tr>
            <th>Start</th>
            <th>Ende</th>
            <th>Dauer</th>
            <th>Notiz</th>
          </tr>
        </thead>
        <tbody>
          ${(c.sessions||[]).slice().reverse().map((s,idx)=>{
            const note = escapeHtml(s.note || '');
            return `
              <tr>
                <td>${new Date(s.start).toLocaleString()}</td>
                <td>${s.end ? new Date(s.end).toLocaleString() : '‚Äî'}</td>
                <td>${minutesToHuman(s.durationMin || Math.round(((s.end ? (s.end - s.start) : 0) / 60000)) || 0)}</td>
                <td contenteditable="true" data-idx="${idx}" style="min-width:200px;border:1px solid var(--muted);padding:4px;">${note}</td>
              </tr>`;
          }).join('')}
        </tbody>
      </table>
      <div style="font-size:0.8rem;color:var(--muted);margin-top:6px;">
        Klicke in eine Notiz-Zelle, um Text zu √§ndern. √Ñnderungen werden automatisch gespeichert.
      </div>
    </div>
  `;

  const modal = openModal(content);

  // Notiz√§nderungen speichern
  modal.querySelectorAll('td[contenteditable]').forEach(td=>{
    td.addEventListener('blur', e=>{
      const idx = parseInt(td.dataset.idx,10);
      const session = c.sessions.slice().reverse()[idx];
      if(session){
        session.note = td.textContent.trim();
        save();
      }
    });
  });
}

  function openModal(innerHTML){
    closeModal();
    const backdrop = document.createElement('div'); backdrop.className='modal-backdrop';
    const modal = document.createElement('div'); modal.className='modal';
    modal.innerHTML = innerHTML + `<div style="text-align:right;margin-top:8px"><button id="closeModal" class="small">Schlie√üen</button></div>`;
    backdrop.appendChild(modal); modalRoot.appendChild(backdrop);
    backdrop.querySelector('#closeModal').onclick = ()=> closeModal();
    return modal;
  }
  function closeModal(){ modalRoot.innerHTML=''; }

  // initial values/listeners
    timespanButtons.addEventListener('click',(e)=>{ const b = e.target.closest('button'); if(!b) return; currentRange = b.dataset.range; renderStats(); });

  // Seite vollst√§ndig initialisieren (Cloud-Daten laden, dann rendern)
  (async () => {
    console.log("‚è≥ Lade Daten...");
    await load();    // Warten bis Daten aus GitHub da sind
    renderAll();     // Dann erst alles anzeigen
    console.log("‚úÖ Daten vollst√§ndig geladen und angezeigt");
  })();

  // expose for debugging
  window._zm_state = state;

}); // DOMContentLoaded end
</script>
</body>
</html>






